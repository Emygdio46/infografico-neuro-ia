<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infogr√°fico: Anestesia em Urg√™ncias Neurol√≥gicas (com IA)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #F0F4F8;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .card {
            background-color: #FFFFFF;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border-left: 5px solid #4278B9;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .text-primary { color: #0B2D48; }
        .text-secondary { color: #205493; }
        .text-accent { color: #F5A623; }
        .bg-primary { background-color: #0B2D48; }
        .bg-secondary { background-color: #205493; }
        .flow-arrow {
            font-size: 2rem;
            line-height: 1;
            color: #4278B9;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 2rem;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 0.75rem;
            position: relative;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #0B2D48;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tts-button {
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-block;
            margin-left: 0.5rem;
        }
        .tts-button:hover {
            transform: scale(1.2);
        }
        .tts-button.playing {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-primary text-white text-center py-8 px-4">
        <h1 class="text-4xl md:text-5xl font-black tracking-tight">Anestesia em Urg√™ncias Neurol√≥gicas</h1>
        <p class="text-lg md:text-xl mt-2 max-w-3xl mx-auto">Um Guia Visual de Fisiologia e Farmacologia para Prevenir a Les√£o Cerebral Secund√°ria</p>
    </header>

    <main class="container mx-auto p-4 md:p-8">

        <section id="gemini-features" class="mb-12 card text-center border-l-amber-500">
            <h2 class="text-2xl font-bold text-primary mb-4">Funcionalidades com IA Gemini ‚ú®</h2>
            <p class="text-gray-600 mb-6">Utilize a intelig√™ncia artificial para aprofundar a sua compreens√£o e aplica√ß√£o deste protocolo.</p>
            <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                <button id="generateSummaryBtn" class="bg-secondary text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition-colors">‚ú® Gerar Resumo do Protocolo</button>
                <button id="simulateScenarioBtn" class="bg-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition-colors">‚ú® Simular Cen√°rio Cl√≠nico</button>
            </div>
        </section>

        <section id="monro-kellie" class="mb-12">
            <div class="flex items-center justify-center mb-2">
                <h2 class="text-3xl font-bold text-center text-primary">O Equil√≠brio Intracraniano</h2>
                <span class="tts-button" data-section="monro-kellie" title="Ouvir resumo da sec√ß√£o">üîä</span>
            </div>
            <p class="text-center text-gray-600 mb-8 max-w-4xl mx-auto">O cr√¢nio √© um compartimento r√≠gido com volume constante, composto por tr√™s elementos. Um aumento em um deles deve ser compensado pela diminui√ß√£o de outro para manter a press√£o intracraniana (PIC) normal.</p>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                <div class="card">
                    <h3 class="text-xl font-bold text-center text-secondary mb-4">Doutrina de Monro-Kellie</h3>
                    <div class="chart-container" style="height: 300px; max-height: 300px;">
                        <canvas id="monroKellieChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-bold text-center text-secondary mb-4">Curva de Complac√™ncia Intracraniana</h3>
                    <div class="chart-container" style="height: 300px; max-height: 300px;">
                        <canvas id="complianceChart"></canvas>
                    </div>
                    <p class="text-center text-sm text-gray-600 mt-2">Quando os mecanismos de compensa√ß√£o se esgotam, a complac√™ncia diminui e pequenos aumentos de volume causam eleva√ß√µes exponenciais da PIC.</p>
                </div>
            </div>
        </section>

        <section id="fisiologia" class="mb-12">
            <div class="flex items-center justify-center mb-8">
                <h2 class="text-3xl font-bold text-center text-primary">Fisiologia Cerebral Cr√≠tica</h2>
                <span class="tts-button" data-section="fisiologia" title="Ouvir resumo da sec√ß√£o">üîä</span>
            </div>
            <div class="card bg-secondary text-white text-center p-6 mb-8">
                <h3 class="text-2xl font-bold">Press√£o de Perfus√£o Cerebral (PPC)</h3>
                <p class="text-4xl font-black my-4">PPC = PAM - PIC</p>
                <p class="max-w-2xl mx-auto">Esta √© a equa√ß√£o fundamental da neuroanestesia. A PPC representa o gradiente de press√£o que impulsiona o fluxo sangu√≠neo para o c√©rebro.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 text-center">
                <div class="card">
                    <h4 class="text-xl font-bold text-secondary">PIC Normal</h4>
                    <p class="text-5xl font-black text-primary my-2">5-15 <span class="text-2xl">mmHg</span></p>
                    <p class="text-gray-600">Valores em repouso na posi√ß√£o supina.</p>
                </div>
                <div class="card border-l-red-500">
                    <h4 class="text-xl font-bold text-red-600">Hipertens√£o Intracraniana (HIC)</h4>
                    <p class="text-5xl font-black text-red-600 my-2">>22 <span class="text-2xl">mmHg</span></p>
                    <p class="text-gray-600">Uma PIC sustentada acima deste valor amea√ßa a perfus√£o cerebral.</p>
                </div>
                <div class="card border-l-green-500">
                    <h4 class="text-xl font-bold text-green-700">Alvo de PPC (TCE)</h4>
                    <p class="text-5xl font-black text-green-700 my-2">60-70 <span class="text-2xl">mmHg</span></p>
                    <p class="text-gray-600">Manter a PPC nesta faixa √© o objetivo na maioria das emerg√™ncias como o TCE grave.</p>
                </div>
            </div>
             <div class="card mt-8">
                    <h3 class="text-xl font-bold text-center text-secondary mb-4">Tr√≠ade de Cushing: Um Sinal Tardio</h3>
                    <div class="flex flex-col md:flex-row items-center justify-around text-center">
                        <div class="p-4 rounded-lg"><p class="text-4xl"> hipertens√£o arterial sist√™mica </p></div>
                        <div class="flow-arrow hidden md:block">+</div>
                        <div class="p-4 rounded-lg"><p class="text-4xl"> bradicardia </p></div>
                        <div class="flow-arrow hidden md:block">+</div>
                        <div class="p-4 rounded-lg"><p class="text-4xl"> padr√£o respirat√≥rio irregular </p></div>
                    </div>
                     <p class="text-center text-sm text-gray-600 mt-4">√â um sinal ominoso que indica descompensa√ß√£o iminente e compress√£o do tronco cerebral.</p>
                </div>
        </section>

        <section id="farmacologia" class="mb-12">
            <div class="flex items-center justify-center mb-2">
                <h2 class="text-3xl font-bold text-center text-primary">Farmacologia Aplicada</h2>
                <span class="tts-button" data-section="farmacologia" title="Ouvir resumo da sec√ß√£o">üîä</span>
            </div>
            <p class="text-center text-gray-600 mb-8 max-w-4xl mx-auto">A escolha dos f√°rmacos deve ponderar o efeito anest√©sico desejado com o impacto na fisiologia cerebral. O controlo do CMRO‚ÇÇ (Metabolismo Cerebral de O‚ÇÇ), FSC (Fluxo Sangu√≠neo Cerebral) e PIC √© essencial.</p>
            <div class="card">
                <h3 class="text-xl font-bold text-center text-secondary mb-4">Efeitos dos Agentes Anest√©sicos na Hemodin√¢mica Cerebral</h3>
                <div class="chart-container" style="height: 500px; max-height: 500px; max-width: 1000px;">
                    <canvas id="pharmaChart"></canvas>
                </div>
            </div>
        </section>

        <section id="monitorizacao" class="mb-12">
            <div class="flex items-center justify-center mb-8">
                <h2 class="text-3xl font-bold text-center text-primary">Monitoriza√ß√£o da Press√£o Intracraniana (PIC)</h2>
                <span class="tts-button" data-section="monitorizacao" title="Ouvir resumo da sec√ß√£o">üîä</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="card border-l-amber-500">
                    <h3 class="text-xl font-bold text-secondary">Cateter Intraventricular (DVE)</h3>
                    <p class="font-bold my-2 text-amber-600">Padr√£o-Ouro</p>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><span class="font-semibold">Vantagens:</span> M√°xima precis√£o; permite drenagem terap√™utica de LCR para tratar a HIC.</li>
                        <li><span class="font-semibold">Desvantagens:</span> Mais invasivo; risco de hemorragia e infec√ß√£o; dif√≠cil inser√ß√£o com ventr√≠culos colapsados.</li>
                    </ul>
                </div>
                <div class="card">
                    <h3 class="text-xl font-bold text-secondary">Cateter Intraparenquimatoso</h3>
                    <p class="font-bold my-2 text-secondary">Alternativa</p>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><span class="font-semibold">Vantagens:</span> Alta precis√£o; mais f√°cil de inserir em edema grave.</li>
                        <li><span class="font-semibold">Desvantagens:</span> Apenas monitoriza√ß√£o (sem terapia); risco de "deriva do zero".</li>
                    </ul>
                </div>
                <div class="card">
                    <h3 class="text-xl font-bold text-secondary">Di√¢metro da Bainha do Nervo √ìptico</h3>
                     <p class="font-bold my-2 text-secondary">Rastreio/Triagem N√£o Invasiva</p>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><span class="font-semibold">Vantagens:</span> R√°pido, n√£o invasivo, port√°til, alta sensibilidade para HIC.</li>
                        <li><span class="font-semibold">Desvantagens:</span> Medi√ß√£o indireta; dependente do operador. Um di√¢metro > 5.0-5.8 mm √© altamente sugestivo de HIC.</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="abordagens" class="mb-12">
             <div class="flex items-center justify-center mb-2">
                <h2 class="text-3xl font-bold text-center text-primary">Abordagens em Condi√ß√µes Espec√≠ficas</h2>
                <span class="tts-button" data-section="abordagens" title="Ouvir resumo da sec√ß√£o">üîä</span>
            </div>
            <p class="text-center text-gray-600 mb-8 max-w-4xl mx-auto">N√£o existe uma abordagem hemodin√¢mica √∫nica. O diagn√≥stico preciso da fisiopatologia subjacente √© essencial para definir a estrat√©gia anest√©sica correta.</p>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="card border-l-red-500">
                    <h3 class="text-xl font-bold text-red-600">Traumatismo Cranioencef√°lico (TCE)</h3>
                    <p class="text-lg font-black text-primary my-3">INIMIGO: HIPOTENS√ÉO</p>
                    <p class="text-gray-700">Um √∫nico epis√≥dio de hipotens√£o pode dobrar a mortalidade.</p>
                    <ul class="list-disc list-inside space-y-2 mt-4">
                        <li><span class="font-semibold">Alvo de PPC:</span> 60-70 mmHg.</li>
                        <li><span class="font-semibold">Fluidos:</span> Solu√ß√µes cristaloides isot√≥nicas (Salina 0.9%). Ringer Lactato √© contraindicado.</li>
                        <li><span class="font-semibold">Ventila√ß√£o:</span> Manter normocapnia (PaCO‚ÇÇ 35-45 mmHg).</li>
                    </ul>
                </div>
                <div class="card border-l-sky-500">
                    <h3 class="text-xl font-bold text-sky-600">AVC Isqu√©mico (Trombectomia)</h3>
                    <p class="text-lg font-black text-primary my-3">INIMIGO: HIPOTENS√ÉO</p>
                    <p class="text-gray-700">A instabilidade hemodin√¢mica pode anular o benef√≠cio de uma recanaliza√ß√£o bem-sucedida.</p>
                     <ul class="list-disc list-inside space-y-2 mt-4">
                        <li><span class="font-semibold">AG vs. SC:</span> A Anestesia Geral (AG) tem maior sucesso de recanaliza√ß√£o, mas sem diferen√ßa no desfecho funcional.</li>
                        <li><span class="font-semibold">Foco principal:</span> Prevenir a hipotens√£o, independentemente da t√©cnica.</li>
                     </ul>
                </div>
                <div class="card border-l-orange-500">
                    <h3 class="text-xl font-bold text-orange-600">HSA (Aneurisma N√£o Tratado)</h3>
                    <p class="text-lg font-black text-primary my-3">INIMIGO: HIPERTENS√ÉO</p>
                    <p class="text-gray-700">Aumentos abruptos da PAM podem levar a um novo sangramento, que √© frequentemente fatal.</p>
                    <ul class="list-disc list-inside space-y-2 mt-4">
                         <li><span class="font-semibold">Controlo da PA:</span> Controlo rigoroso da press√£o arterial, mantendo-a em n√≠veis mais baixos.</li>
                         <li><span class="font-semibold">Vasoespasmo:</span> Complica√ß√£o tardia (dias 4-14) que pode exigir hipertens√£o induzida.</li>
                    </ul>
                </div>
            </div>
        </section>
        
        <section id="hic-refrataria" class="mb-12">
            <div class="flex items-center justify-center mb-8">
                <h2 class="text-3xl font-bold text-center text-primary">Manejo da HIC Refrat√°ria</h2>
                <span class="tts-button" data-section="hic-refrataria" title="Ouvir resumo da sec√ß√£o">üîä</span>
            </div>
             <p class="text-center text-gray-600 mb-8 max-w-4xl mx-auto">PIC que permanece elevada (>22 mmHg) apesar das medidas de primeira linha, associada a uma mortalidade extremamente elevada.</p>
            <div class="flex flex-col md:flex-row items-stretch justify-center text-center gap-4">
                <div class="card flex-1"><h3 class="text-xl font-bold text-secondary">Coma Barbit√∫rico</h3><p class="mt-2 text-sm">Reduz drasticamente o CMRO‚ÇÇ, FSC e PIC, mas com risco de hipotens√£o severa.</p></div>
                <div class="self-center flow-arrow mx-4">‚Üí</div>
                <div class="card flex-1"><h3 class="text-xl font-bold text-secondary">Hipotermia Terap√™utica</h3><p class="mt-2 text-sm">Uso controverso, n√£o recomendado como rotina devido √† falta de benef√≠cio e aumento de complica√ß√µes.</p></div>
                <div class="self-center flow-arrow mx-4">‚Üí</div>
                <div class="card flex-1 border-l-red-500"><h3 class="text-xl font-bold text-red-600">Craniectomia Descompressiva</h3><p class="mt-2 text-sm">Interven√ß√£o de √∫ltimo recurso que salva vidas, mas pode resultar em sobreviventes com incapacidade neurol√≥gica grave.</p></div>
            </div>
        </section>
    </main>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="absolute top-4 right-6 text-2xl font-bold cursor-pointer">&times;</span>
            <h3 id="modalTitle" class="text-2xl font-bold text-primary mb-4">Resultado da IA</h3>
            <div id="modalBody">
                <div class="loader"></div>
            </div>
        </div>
    </div>

    <div id="scenarioModal" class="modal">
        <div class="modal-content">
            <span id="closeScenarioModal" class="absolute top-4 right-6 text-2xl font-bold cursor-pointer">&times;</span>
            <h3 class="text-2xl font-bold text-primary mb-4">Simular Cen√°rio Cl√≠nico</h3>
            <p class="text-gray-600 mb-4">Descreva a situa√ß√£o cl√≠nica abaixo (ex: "Paciente com TCE grave, Glasgow 6, PIC 25 mmHg, PA 100/60 mmHg").</p>
            <textarea id="scenarioInput" class="w-full h-32 p-2 border border-gray-300 rounded-lg" placeholder="Descreva o cen√°rio..."></textarea>
            <button id="generatePlanBtn" class="mt-4 bg-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition-colors w-full">Gerar Plano de A√ß√£o</button>
        </div>
    </div>

    <footer class="bg-primary text-white text-center py-4 mt-8">
        <p class="text-sm">Infogr√°fico gerado com base no documento "Anestesia en Urgencias Neurol√≥gicas.docx". Para fins educacionais.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const resultModal = document.getElementById('resultModal');
            const scenarioModal = document.getElementById('scenarioModal');
            const closeModal = document.getElementById('closeModal');
            const closeScenarioModal = document.getElementById('closeScenarioModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const generateSummaryBtn = document.getElementById('generateSummaryBtn');
            const simulateScenarioBtn = document.getElementById('simulateScenarioBtn');
            const generatePlanBtn = document.getElementById('generatePlanBtn');
            const scenarioInput = document.getElementById('scenarioInput');
            const ttsButtons = document.querySelectorAll('.tts-button');
            let currentAudio = null;

            // A chave de API foi removida daqui para seguran√ßa.
            // As chamadas agora s√£o feitas para a nossa fun√ß√£o serverless.
            const serverlessEndpoint = '/api/gemini'; 

            function showModal(title) {
                modalTitle.textContent = title;
                modalBody.innerHTML = '<div class="loader"></div>';
                resultModal.style.display = 'block';
            }

            function hideModal() {
                resultModal.style.display = 'none';
            }

            closeModal.onclick = hideModal;
            window.onclick = function(event) {
                if (event.target == resultModal) {
                    hideModal();
                }
                if (event.target == scenarioModal) {
                    scenarioModal.style.display = 'none';
                }
            }

            async function callServerlessAPI(payload) {
                try {
                    const response = await fetch(serverlessEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erro do servidor: ${response.status} ${errorText}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Erro ao chamar a fun√ß√£o serverless:", error);
                    // Retorna um objeto com a estrutura de erro esperada para ser tratado.
                    return { error: { message: "Desculpe, ocorreu um erro de comunica√ß√£o. Por favor, tente novamente mais tarde." } };
                }
            }

            function getFullProtocolText() {
                let text = '';
                document.querySelectorAll('main section').forEach(section => {
                    const title = section.querySelector('h2');
                    if (title) {
                        text += title.innerText + '\n\n';
                        section.querySelectorAll('p, li, th, td').forEach(el => {
                            text += el.innerText + '\n';
                        });
                        text += '\n---\n\n';
                    }
                });
                return text;
            }

            generateSummaryBtn.addEventListener('click', async () => {
                showModal('Resumo do Protocolo');
                const protocolText = getFullProtocolText();
                const prompt = `Voc√™ √© um especialista em resumos m√©dicos. Com base no seguinte protocolo de anestesia em urg√™ncias neurol√≥gicas, crie um resumo conciso em t√≥picos para um anestesista usar como refer√™ncia r√°pida. Foque nos objetivos, alvos fisiol√≥gicos (PIC, PPC), e considera√ß√µes farmacol√≥gicas chave. Responda em Markdown. Contexto do protocolo: \n\n${protocolText}`;
                
                const data = await callServerlessAPI({ prompt: prompt, type: 'text' });
                
                if (data.candidates && data.candidates.length > 0) {
                    const result = data.candidates[0].content.parts[0].text;
                    modalBody.innerHTML = result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                } else {
                    modalBody.textContent = data.error?.message || "N√£o foi poss√≠vel gerar o resumo.";
                }
            });

            simulateScenarioBtn.addEventListener('click', () => {
                scenarioModal.style.display = 'block';
            });
            
            closeScenarioModal.onclick = () => {
                scenarioModal.style.display = 'none';
            };

            generatePlanBtn.addEventListener('click', async () => {
                const scenario = scenarioInput.value;
                if (!scenario.trim()) {
                    alert("Por favor, descreva um cen√°rio.");
                    return;
                }
                scenarioModal.style.display = 'none';
                showModal('Plano de A√ß√£o para o Cen√°rio');
                const protocolText = getFullProtocolText();
                const prompt = `Voc√™ √© um anestesista especialista a atuar como uma ferramenta de apoio √† decis√£o cl√≠nica. O seu conhecimento est√° estritamente limitado ao protocolo de anestesia em urg√™ncias neurol√≥gicas fornecido. Um utilizador descreveu um cen√°rio cl√≠nico. Com base APENAS no protocolo abaixo, forne√ßa um plano de a√ß√£o claro, passo a passo. N√£o forne√ßa informa√ß√µes ou conselhos fora deste protocolo. Responda em Markdown. \n\n---PROTOCOLO---\n${protocolText}\n\n---CEN√ÅRIO---\n${scenario}\n\n---PLANO DE A√á√ÉO---`;
                
                const data = await callServerlessAPI({ prompt: prompt, type: 'text' });

                if (data.candidates && data.candidates.length > 0) {
                    const result = data.candidates[0].content.parts[0].text;
                    modalBody.innerHTML = result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                } else {
                    modalBody.textContent = data.error?.message || "N√£o foi poss√≠vel gerar o plano de a√ß√£o.";
                }
            });
            
            function base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }

            function pcmToWav(pcmData, sampleRate) {
                const numChannels = 1;
                const bytesPerSample = 2; 
                const blockAlign = numChannels * bytesPerSample;
                const byteRate = sampleRate * blockAlign;
                const dataSize = pcmData.length * bytesPerSample;
                const buffer = new ArrayBuffer(44 + dataSize);
                const view = new DataView(buffer);

                function writeString(view, offset, string) {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                }

                writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + dataSize, true);
                writeString(view, 8, 'WAVE');
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, byteRate, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, 16, true);
                writeString(view, 36, 'data');
                view.setUint32(40, dataSize, true);

                const pcm16 = new Int16Array(pcmData.buffer);
                for (let i = 0; i < pcmData.length; i++) {
                    view.setInt16(44 + i * 2, pcm16[i], true);
                }
                return new Blob([view], { type: 'audio/wav' });
            }

            async function callTtsOnServer(text, button) {
                try {
                    const result = await callServerlessAPI({ prompt: text, type: 'tts' });
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);

                        if (currentAudio) {
                            currentAudio.pause();
                        }
                        currentAudio = new Audio(audioUrl);
                        currentAudio.play();
                        
                        document.querySelectorAll('.tts-button.playing').forEach(b => b.classList.remove('playing'));
                        button.classList.add('playing');
                        
                        currentAudio.onended = () => {
                           button.classList.remove('playing');
                           currentAudio = null;
                        };
                    } else {
                       throw new Error("Dados de √°udio inv√°lidos recebidos.");
                    }
                } catch (error) {
                    console.error("Erro ao gerar TTS:", error);
                    alert("N√£o foi poss√≠vel gerar o √°udio.");
                    button.classList.remove('playing');
                }
            }

            ttsButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.classList.contains('playing') && currentAudio) {
                        currentAudio.pause();
                        currentAudio = null;
                        button.classList.remove('playing');
                        return;
                    }

                    const sectionId = button.dataset.section;
                    const sectionElement = document.getElementById(sectionId);
                    if (sectionElement) {
                        let textToSpeak = '';
                        const title = sectionElement.querySelector('h2');
                        if (title) textToSpeak += title.innerText + ". ";
                        sectionElement.querySelectorAll('p, li').forEach(el => {
                            textToSpeak += el.innerText + ". ";
                        });
                        callTtsOnServer(textToSpeak.substring(0, 1000), button); 
                    }
                });
            });

            const tooltipTitleCallback = function(tooltipItems) {
                const item = tooltipItems[0];
                let label = item.chart.data.labels[item.dataIndex];
                if (Array.isArray(label)) {
                    return label.join(' ');
                }
                return label;
            };

            const sharedTooltipOptions = {
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: tooltipTitleCallback
                        }
                    }
                }
            };

            const monroKellieCtx = document.getElementById('monroKellieChart').getContext('2d');
            new Chart(monroKellieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Par√™nquima Cerebral (80%)', 'Sangue (10%)', 'L√≠quor (LCR) (10%)'],
                    datasets: [{
                        data: [80, 10, 10],
                        backgroundColor: ['#0B2D48', '#4278B9', '#B0C4DE'],
                        borderColor: '#FFFFFF',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: sharedTooltipOptions.plugins.tooltip
                    }
                }
            });
            
            const complianceCtx = document.getElementById('complianceChart').getContext('2d');
            new Chart(complianceCtx, {
                type: 'line',
                data: {
                    labels: ['0', '1', '2', '3', '4', '5', '5.5', '6'],
                    datasets: [{
                        label: 'Press√£o Intracraniana (PIC)',
                        data: [10, 11, 12, 14, 18, 25, 50, 90],
                        borderColor: '#D8315B',
                        backgroundColor: 'rgba(216, 49, 91, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: { display: true, text: 'PIC (mmHg)' }
                        },
                        x: {
                            title: { display: true, text: 'Volume Adicionado (unidades arbitr√°rias)' }
                        }
                    },
                    plugins: {
                         legend: { display: false },
                         tooltip: sharedTooltipOptions.plugins.tooltip
                    }
                }
            });
            
            const pharmaCtx = document.getElementById('pharmaChart').getContext('2d');
            const pharmaData = {
                labels: ['Propofol', 'Etomidato', 'Cetamina', 'Sevoflurano', 'Opioides', 'Rocur√¥nio'],
                datasets: [
                    {
                        label: 'PIC',
                        data: [-2, -2, 1, 1, 0, 0],
                        backgroundColor: '#0B2D48',
                    },
                    {
                        label: 'FSC',
                        data: [-2, -2, 1, 1, 0, 0],
                        backgroundColor: '#205493',
                    },
                     {
                        label: 'CMRO‚ÇÇ',
                        data: [-2, -2, 1, -1, -0.5, 0],
                        backgroundColor: '#4278B9',
                    },
                    {
                        label: 'PPC (indireto)',
                        data: [-1, 0, 1, -1, 0, 0],
                        backgroundColor: '#F5A623',
                    }
                ]
            };
            new Chart(pharmaCtx, {
                type: 'bar',
                data: pharmaData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                     scales: {
                        y: {
                            ticks: {
                                callback: function(value, index, values) {
                                    switch(value) {
                                        case 2: return '‚Üë‚Üë Aumento Ac.';
                                        case 1: return '‚Üë Aumento';
                                        case 0: return '‚Üî Nulo';
                                        case -1: return '‚Üì Redu√ß√£o';
                                        case -2: return '‚Üì‚Üì Redu√ß√£o Ac.';
                                        default: return '';
                                    }
                                }
                            },
                             title: { display: true, text: 'Efeito na Hemodin√¢mica Cerebral' }
                        }
                    },
                     plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                title: tooltipTitleCallback,
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.raw;
                                    let effect = '‚Üî Nulo';
                                     if (value === 2) effect = '‚Üë‚Üë Aumento Ac.';
                                     else if (value === 1) effect = '‚Üë Aumento';
                                     else if (value === -1) effect = '‚Üì Redu√ß√£o';
                                     else if (value === -2) effect = '‚Üì‚Üì Redu√ß√£o Ac.';
                                     else if (value === -0.5) effect = '‚Üì Redu√ß√£o Leve';
                                    label += effect;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>

</body>
</html>
